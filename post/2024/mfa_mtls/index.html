<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>When Certificates Fail: A Story of Bypassed MFA in Remote Access - </title><meta name=description content="Long time no see! After 3 years of no new blog posts and also no conference talks from my side, I decided it&rsquo;s time to write again. I&rsquo;ll start easy with a fun story that happened a while ago. I gave a short lightning talk about this on Alligatorcon 2024, but as it may be of greater interest, ChatGPT and I wrote a little more elaborate version that consists of full sentences. If you prefer clicking through my original slides, you can find them here."><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"edermi\u0027s Blog","url":"https:\/\/edermi.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/edermi.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/edermi.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/edermi.github.io\/post\/2024\/mfa_mtls\/","name":"When certificates fail a story of bypassed mfa in remote access"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":""},"headline":"When Certificates Fail: A Story of Bypassed MFA in Remote Access","description":"Long time no see! After 3 years of no new blog posts and also no conference talks from my side, I decided it\u0026rsquo;s time to write again. I\u0026rsquo;ll start easy with a fun story that happened a while ago. I gave a short lightning talk about this on Alligatorcon 2024, but as it may be of greater interest, ChatGPT and I wrote a little more elaborate version that consists of full sentences. If you prefer clicking through my original slides, you can find them here.\n","inLanguage":"en","wordCount":1108,"datePublished":"2024-09-09T00:00:00\u002b00:00","dateModified":"2024-09-09T19:16:44\u002b02:00","image":"https:\/\/edermi.github.io\/","keywords":["red team, phishing, citrix, mTLS, initial access, certificate, smart card"],"mainEntityOfPage":"https:\/\/edermi.github.io\/post\/2024\/mfa_mtls\/","publisher":{"@type":"Organization","name":"https:\/\/edermi.github.io\/","logo":{"@type":"ImageObject","url":"https:\/\/edermi.github.io\/","height":60,"width":60}}}</script><meta property="og:title" content="When Certificates Fail: A Story of Bypassed MFA in Remote Access"><meta property="og:description" content="Long time no see! After 3 years of no new blog posts and also no conference talks from my side, I decided it&rsquo;s time to write again. I&rsquo;ll start easy with a fun story that happened a while ago. I gave a short lightning talk about this on Alligatorcon 2024, but as it may be of greater interest, ChatGPT and I wrote a little more elaborate version that consists of full sentences. If you prefer clicking through my original slides, you can find them here."><meta property="og:url" content="https://edermi.github.io/post/2024/mfa_mtls/"><meta property="og:type" content="website"><meta property="og:site_name" content="edermi's Blog"><meta name=twitter:title content="When Certificates Fail: A Story of Bypassed MFA in Remote Access"><meta name=twitter:description content="Long time no see! After 3 years of no new blog posts and also no conference talks from my side, I decided it&rsquo;s time to write again. I&rsquo;ll start easy with a fun story that happened a while …"><meta name=twitter:card content="summary_large_image"><meta name=generator content="Hugo 0.134.1"><link rel=alternate href=https://edermi.github.io/index.xml type=application/rss+xml title="edermi's Blog"><link rel=stylesheet href=https://edermi.github.io/css/katex.min.css><link rel=stylesheet href=https://edermi.github.io/fontawesome/css/all.css><link rel=stylesheet href=https://edermi.github.io/css/bootstrap.min.css><link rel=stylesheet href=https://edermi.github.io/css/main.css><link rel=stylesheet href=https://edermi.github.io/css/fonts.css><link rel=stylesheet href=https://edermi.github.io/css/syntax.css><link rel=stylesheet href=https://edermi.github.io/css/codeblock.css><link rel=stylesheet href=https://edermi.github.io/css/photoswipe.min.css><link rel=stylesheet href=https://edermi.github.io/css/photoswipe.default-skin.min.css></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://edermi.github.io/>edermi's Blog</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=About href=/about/>About</a></li><li><a title=Turingcomplete href=/turingcomplete/>Turingcomplete</a></li></ul></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>When Certificates Fail: A Story of Bypassed MFA in Remote Access</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on 2024-09-09
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;6&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;1108&nbsp;words</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>Long time no see! After 3 years of no new blog posts and also no conference talks from my side, I decided it&rsquo;s time to write again. I&rsquo;ll start easy with a fun story that happened a while ago. I gave a short lightning talk about this on <a href=https://alligatorcon.eu/index-2024.html>Alligatorcon 2024</a>, but as it may be of greater interest, ChatGPT and I wrote a little more elaborate version that consists of full sentences. If you prefer clicking through my original slides, <a href=https://github.com/edermi/papers/blob/master/AlligatorconEU2024%20-%20Lightning%20Talk%20Not%20So%20Smart%20Card/Lightning%20Talk%20MFA%20Alligatorcon%202024.pdf>you can find them here</a>.</p><h3 id=introduction>Introduction</h3><p>During a penetration test of a customer’s Citrix infrastructure, my task was to evaluate potential vulnerabilities in their authentication mechanisms and identify possible vectors for initial access. Armed with valid credentials, I was able to scrutinize the authentication process in detail, and it didn’t take long to identify a significant misconfiguration—one that could allow an attacker to bypass multi-factor authentication (MFA) with a surprisingly simple method.</p><h3 id=how-authentication-usually-works>How Authentication (Usually) Works</h3><p>In a typical secure environment, the authentication process follows these steps:</p><ol><li>The user enters their username.</li><li>The user enters their password.</li><li>The user provides a one-time password (OTP) from a hardware token, such as an RSA token.</li></ol><p>This is how it often looks like:
<img src=images/citrix-1.png alt="Citrix Login with RSA"></p><p>This is widely state of the art, and though considered secure, it isn&rsquo;t perfect: &ldquo;Sophisticated&rdquo; attackers (those being hacked always say the hackers have been sophisticated, so whatever&mldr;) may use tools like <a href=https://github.com/drk1wi/Modlishka>Modlishka</a> or <a href=https://github.com/kgretzky/evilginx2>Evilginx</a> to perform phishing attacks, where traffic is routed via the attacker&rsquo;s server but ultimately sent to the original target, leading to a succesfull authentication for the victim while the attacker sniffs all the creds and tokens.</p><h3 id=the-customers-approach>The Customer’s Approach</h3><p>In this case, the customer decided that additionally to this common process, it might be a good idea to utilize their already existing Public Key Infrastructure (PKI). Each user was issued a smart card containing their personal certificate, which was mandatory for logging into regular clients. The idea was that if this system works for physical devices, extending it to secure remote access should be straightforward and provide additional security. In theory, hardware tokens like smart cards should leave no room for intruders, as even modern reverse-proxy based phishing attacks won&rsquo;t be able to intercept that connection. Also, you don&rsquo;t have to buy and manage RSA tokens for each user.</p><h3 id=a-quick-recap-on-mutual-tls-mtls>A Quick Recap on Mutual TLS (mTLS)</h3><p>For those unfamiliar with mutual TLS (mTLS), it’s an enhancement of regular TLS. In mTLS, the server not only authenticates itself to the client but also requests a certificate from the client for verification. This ensures that both parties present valid and trusted certificates to establish a secure connection. If you&rsquo;re interested in details, you may start your journey <a href=https://en.wikipedia.org/wiki/Mutual_authentication#mTLS>here</a>.</p><p>As part of the mTLS process, the server sends the client a list of trusted Certificate Authorities (CAs), allowing the client to select the appropriate certificate for authentication.</p><h3 id=the-actual-implementation>The Actual Implementation</h3><p>In this particular setup, the Citrix endpoint attempted to establish an mTLS connection. If the client certificate wasn’t provided or the connection failed, the system would fall back to regular TLS (where only the server is authenticated). At that point, the user was prompted to enter their username, password, and RSA token.</p><p>However, if the mTLS connection was successfully established, the system extracted the User Principal Name (UPN) from the user’s certificate. The login screen would then display a form with the username pre-filled (and greyed out) based on the UPN, and the user would be asked to provide their password:
<img src=images/citrix-2.png alt="Citrix Login with mTLS"></p><p>This process was designed to be seamless and transparent, requiring no additional software and providing a convenient &ldquo;quality of life&rdquo; as well as security improvement for users who already had smart cards.</p><h3 id=the-vulnerability-bypassing-mfa>The Vulnerability: Bypassing MFA</h3><p>Although the username field was greyed out, this was merely a superficial HTML attribute. Using the browser’s developer tools, it was possible to modify the form directly and remove this restriction. Once that was done, the username field became fully editable, and I could attempt to log in as any user, provided I knew their password.</p><p>Before:
<img src=images/citrix-3.png alt="Citrix username field disabled"></p><p>After:
<img src=images/citrix-4.png alt="Citrix username field not disabled"></p><p>This vulnerability meant that if an attacker obtained <em>any</em> certificate issued by the company, phishing or credential stuffing attacks became feasible, as there was effectively no MFA enforcement once the certificate was in hand. As the modifications can be done from within the browser&rsquo;s inspector, it isn&rsquo;t even required to hook Burp or any other tooling into the connection (which usually isn&rsquo;t fun with smart cards).</p><h3 id=whats-happening-under-the-hood>What’s Happening Under the Hood?</h3><p>The issue stemmed from how the system handled the UPN extracted from the certificate during mTLS authentication. The UPN was used to populate the username field, but the system did not perform any subsequent checks to ensure that the individual logging in was the same as the one associated with the certificate.</p><p>This oversight allowed anyone with access to a valid certificate (not necessarily the user&rsquo;s certificate) to authenticate with just a username and password, bypassing the intended multi-factor authentication process entirely. At this point, phishing user&rsquo;s passwords becomes powerful again!</p><h3 id=any-certificate>Any Certificate?</h3><p>An interesting discovery was that even computer certificates (or probably others, like web server certificates, etc., didn&rsquo;t test those though) could be used for mTLS authentication. While these certificates didn’t contain a UPN, the system would fall back to the username &ldquo;anonymous&rdquo;, but as we&rsquo;re going to provide the desired usernames on our own, this was not a big issue.</p><p>As for obtaining a computer certificate? It didn’t require advanced hacking tools. No need for Mimikatz or specialized certificate extraction techniques. Simply requesting a new certificate (I had a client and sufficient privileges) and ensuring the private key was marked as exportable was enough to get a valid certificate that was not tied to hardware and could be used from any system.</p><h3 id=conclusion>Conclusion</h3><p>This vulnerability highlights an important lesson: when designing or evaluating authentication mechanisms, it is crucial to ensure that the credentials and identities used are consistently validated, as attackers may try to alter them during the authentication flows. Otherwise, you’re left with rather a VPN connection (technically, it&rsquo;s even zero trust!), but not truly enforcing multi-factor authentication.</p><p><em>Final remark</em>: This is not a vulnerability in Citrix, Browsers, the PKI, RSA or any other involved software; it&rsquo;s a misconfiguration in a specific setup. This isn&rsquo;t even specifically related to Citrix, you could introduce this vulnerability on any application by configuring it this way. Hence there is no CVE and, unless your MFA is selfmade like this example, no immediate risk for users.
Apparently, the customer implemented a fix and the application takes care that the same user that authenticates via mTLS also authenticates on the application.</p><div class=blog-tags><a href=https://edermi.github.io/tags/red-team/>red team</a>&nbsp;
<a href=https://edermi.github.io/tags/phishing/>phishing</a>&nbsp;
<a href=https://edermi.github.io/tags/citrix/>citrix</a>&nbsp;
<a href=https://edermi.github.io/tags/mtls/>mTLS</a>&nbsp;
<a href=https://edermi.github.io/tags/initial-access/>initial access</a>&nbsp;
<a href=https://edermi.github.io/tags/certificate/>certificate</a>&nbsp;
<a href=https://edermi.github.io/tags/smart-card/>smart card</a>&nbsp;</div></article><ul class="pager blog-pager"><li class=previous><a href=https://edermi.github.io/post/2021/vmware_vulnerabilities/ data-toggle=tooltip data-placement=top title="Vulnerabilities on vmwareidentity.de (XSS) and in VMware UEM (exportable authentication certificate)">&larr; Previous Post</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"></ul><p class="credits copyright text-muted">&nbsp;&bull;&nbsp;&copy;
2024
&nbsp;&bull;&nbsp;
<a href=https://edermi.github.io/>edermi's Blog</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.134.1</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a>
&nbsp;&bull;&nbsp;[<a href=https://github.com/edermi/edermi.github.io/tree/0ca214aadd5bc603860b5582f8c5e12af59ce1b4>0ca214aa</a>]</p></div></div></div></footer><script defer src=https://edermi.github.io/js/katex.min.js></script><script defer src=https://edermi.github.io/js/auto-render.min.js onload=renderMathInElement(document.body)></script><script src=https://edermi.github.io/js/jquery-3.7.0.slim.min.js></script><script src=https://edermi.github.io/js/bootstrap.min.js></script><script src=https://edermi.github.io/js/main.js></script><script src=https://edermi.github.io/js/photoswipe.min.js></script><script src=https://edermi.github.io/js/photoswipe-ui-default.min.js></script><script src=https://edermi.github.io/js/load-photoswipe.js></script></body></html>